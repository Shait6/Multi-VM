name: Deploy Multi-Region VM Backup

on:
  workflow_dispatch:
    inputs:
      subscriptionId:
        description: 'Azure Subscription ID'
        required: true
      enableAutoRemediation:
        description: 'Enable Auto-Remediation (DeployIfNotExists)'
        required: false
        default: 'false'
        type: choice
        options: ['true','false']
      deploymentLocation:
        description: 'Subscription deployment metadata location'
        required: false
        default: 'westeurope'
        type: choice
        options: ['westeurope','northeurope','swedencentral','germanywestcentral']
      weeklyBackupDaysOfWeek:
        description: 'Weekly backup days (comma separated)'
        required: false
        default: 'Sunday,Wednesday'
      retentionProfile:
        description: 'Composite: Daily|Weekly|Yearly|TagName|TagValue (Yearly=0 disables yearly tier)'
        required: false
        default: '14|30|0|backup|true'
      backupFrequency:
        description: 'Backup frequency'
        required: false
        default: 'Weekly'
        type: choice
        options: ['Daily','Weekly','Both']
      backupScheduleTime:
        description: 'Backup schedule time (HH:mm) increments of 30 minutes'
        required: false
        default: '18:30'
      backupTimeZone:
        description: 'Backup schedule time zone (Windows Time Zone ID)'
        required: false
        default: 'UTC'
        type: choice
        options:
          - 'UTC'
          - 'Central Europe Standard Time'
      remediationRegions:
        description: 'Comma-separated regions to remediate (empty -> deploymentLocation)'
        required: false
        default: ''
      instantRestoreRetentionDays:
        description: 'Instant restore retention (days). Weekly or Both: weekly policy uses 5; daily uses this value (1â€“5).'
        required: false
        default: '2'
        type: choice
        options: ['1','2','3','4','5']

jobs:
  deploy_infrastructure:
    runs-on: windows-latest
    outputs:
      vmTagName: ${{ steps.deploy_backup.outputs.vmTagName }}
      vmTagValue: ${{ steps.deploy_backup.outputs.vmTagValue }}
    env:
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      ENABLE_AUTO_REMEDIATION: ${{ github.event.inputs.enableAutoRemediation }}
      DEPLOYMENT_LOCATION: ${{ github.event.inputs.deploymentLocation }}
      WEEKLY_DAYS: ${{ github.event.inputs.weeklyBackupDaysOfWeek }}
      BACKUP_FREQUENCY: ${{ github.event.inputs.backupFrequency }}
      RETENTION_PROFILE: ${{ github.event.inputs.retentionProfile }}
      VM_TAG_NAME: ''
      VM_TAG_VALUE: ''
      BACKUP_TIME: ${{ github.event.inputs.backupScheduleTime }}
      BACKUP_TZ: ${{ github.event.inputs.backupTimeZone }}
      INSTANT_RESTORE_DAYS: ${{ github.event.inputs.instantRestoreRetentionDays }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.NYK_ES_LDZ_SUB_107_SC }}

      - name: Bicep build (syntax check)
        shell: pwsh
        run: |
          try { az bicep version | Out-Null } catch { az bicep install }
          az bicep build --file main.bicep --outdir bicep-build

      - name: Deploy multi-region backup (subscription scope)
        id: deploy_backup
        shell: pwsh
        run: |
          . ./scripts/Deploy-BackupInfra.ps1

  deploy_policy:
    needs: deploy_infrastructure
    if: ${{ github.event.inputs.enableAutoRemediation == 'true' }}
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.NYK_ES_LDZ_SUB_107_SC }}

      - name: Deploy policy definition (rules file)
        shell: pwsh
        run: |
          $policyName = 'Custom-CentralVmBackup'
          $rulesFile = 'policy-definitions/customCentralVmBackup.rules.json'
          $fullFile = 'policy-definitions/customCentralVmBackup.full.json'
          if (-not (Test-Path $rulesFile)) { Write-Host "Rules file not found: $rulesFile"; exit 0 }
          Write-Host "Creating policy definition $policyName from rules file $rulesFile"
          # If params are present in full JSON, extract them to a temp file
          $paramsArg = $null
          if (Test-Path $fullFile) {
            try {
              $raw = Get-Content -Raw -Path $fullFile | ConvertFrom-Json
              if ($raw.properties -and $raw.properties.parameters) {
                $tmpParams = [System.IO.Path]::GetTempFileName() + '.json'
                $raw.properties.parameters | ConvertTo-Json -Depth 99 | Out-File -FilePath $tmpParams -Encoding utf8
                $paramsArg = $tmpParams
              }
            } catch {
              Write-Warning "Failed to parse full JSON params: $($_.Exception.Message)"
            }
          }
          try {
            if ($paramsArg) {
              az policy definition create --name $policyName --display-name "Central VM Backup" --description "Any tagged VM in region backed up to vault using specified policy." --rules $rulesFile --params $paramsArg --mode Indexed -o json
            } else {
              az policy definition create --name $policyName --display-name "Central VM Backup" --description "Any tagged VM in region backed up to vault using specified policy." --rules $rulesFile --mode Indexed -o json
            }
          } finally {
            if ($paramsArg -and (Test-Path $paramsArg)) { Remove-Item $paramsArg -Force }
          }
          Write-Host "Policy definition created. Showing stored policyRule snippet"
          az policy definition show -n $policyName --query properties.policyRule -o json

  remediate:
    if: ${{ github.event.inputs.enableAutoRemediation == 'true' }}
    needs: [deploy_infrastructure , deploy_policy]
    runs-on: windows-latest
    env:
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      DEPLOYMENT_LOCATION: ${{ github.event.inputs.deploymentLocation }}
      BACKUP_FREQUENCY: ${{ github.event.inputs.backupFrequency }}
      VM_TAG_NAME: ${{ needs.deploy_infrastructure.outputs.vmTagName }}
      VM_TAG_VALUE: ${{ needs.deploy_infrastructure.outputs.vmTagValue }}
      REMEDIATION_REGIONS: ${{ github.event.inputs.remediationRegions }}
      WAIT_MINUTES: '5'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.NYK_ES_LDZ_SUB_107_SC }}

      - name: Trigger remediation (per-region)
        shell: pwsh
        run: |
          if (-not $env:VM_TAG_NAME -or -not $env:VM_TAG_VALUE) { Write-Error "Tag name/value not supplied from deployment outputs. Check retentionProfile format and workflow output wiring."; exit 1 }
          . ./scripts/Start-BackupRemediation.ps1
          
