name: Deploy Multi-Region VM Backup

on:
  workflow_dispatch:
    inputs:
      subscriptionId:
        description: 'Azure Subscription ID'
        required: true
      enableAutoRemediation:
        description: 'Enable Auto-Remediation (DeployIfNotExists)'
        required: false
        default: 'false'
        type: choice
        options: ['true','false']
      deploymentLocation:
        description: 'Subscription deployment metadata location'
        required: false
        default: 'westeurope'
        type: choice
        options: ['westeurope','northeurope','swedencentral','germanywestcentral']
      weeklyBackupDaysOfWeek:
        description: 'Weekly backup days (comma separated)'
        required: false
        default: 'Sunday,Wednesday'
      backupFrequency:
        description: 'Backup frequency'
        required: false
        default: 'Daily'
        type: choice
        options: ['Daily','Weekly','Both']
      dailyRetentionDays:
        description: 'Daily retention days'
        required: false
        default: '14'
      weeklyRetentionDays:
        description: 'Weekly retention days'
        required: false
        default: '30'
      backupScheduleTime:
        description: 'Backup schedule time (HH:mm)'
        required: false
        default: '18:30'
      backupTimeZone:
        description: 'Backup schedule time zone'
        required: false
        default: 'UTC'
      instantRestoreRetentionDays:
        description: 'Instant restore retention (days)'
        required: false
        default: '2'
      vmTagName:
        description: 'Tag name used to select VMs for remediation'
        required: false
        default: 'backup'
      vmTagValue:
        description: 'Tag value used to select VMs for remediation'
        required: false
        default: 'true'

jobs:
  deploy:
    runs-on: windows-latest
    env:
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      ENABLE_AUTO_REMEDIATION: ${{ github.event.inputs.enableAutoRemediation }}
      DEPLOYMENT_LOCATION: ${{ github.event.inputs.deploymentLocation }}
      WEEKLY_DAYS: ${{ github.event.inputs.weeklyBackupDaysOfWeek }}
      BACKUP_FREQUENCY: ${{ github.event.inputs.backupFrequency }}
      DAILY_RETENTION: ${{ github.event.inputs.dailyRetentionDays }}
      WEEKLY_RETENTION: ${{ github.event.inputs.weeklyRetentionDays }}
      VM_TAG_NAME: ${{ github.event.inputs.vmTagName }}
      VM_TAG_VALUE: ${{ github.event.inputs.vmTagValue }}
      BACKUP_TIME: ${{ github.event.inputs.backupScheduleTime }}
      BACKUP_TZ: ${{ github.event.inputs.backupTimeZone }}
      INSTANT_RESTORE_DAYS: ${{ github.event.inputs.instantRestoreRetentionDays }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Bicep build (syntax check)
        shell: pwsh
        run: |
          try { az bicep version | Out-Null } catch { az bicep install }
          az bicep build --file main.bicep --outdir bicep-build

      - name: Deploy multi-region backup (subscription scope)
        shell: pwsh
        run: |
          az account set --subscription "$env:SUBSCRIPTION_ID"
          $days = $env:WEEKLY_DAYS.Split(',') | ForEach-Object { $_.Trim() }
          $paramObj = @{
            backupFrequency        = @{ value = $env:BACKUP_FREQUENCY }
            dailyRetentionDays     = @{ value = [int]$env:DAILY_RETENTION }
            weeklyRetentionDays    = @{ value = [int]$env:WEEKLY_RETENTION }
            weeklyBackupDaysOfWeek = @{ value = $days }
            backupScheduleRunTimes = @{ value = @($env:BACKUP_TIME) }
            backupTimeZone         = @{ value = $env:BACKUP_TZ }
            instantRestoreRetentionDays = @{ value = [int]$env:INSTANT_RESTORE_DAYS }
          }
          $paramObj | ConvertTo-Json -Depth 5 | Out-File main-params.json -Encoding utf8
          $deployName = "gh-multi-region-$(Get-Date -Format yyyyMMddHHmmss)"
          echo "Starting deployment $deployName with frequency=$env:BACKUP_FREQUENCY days=$env:WEEKLY_DAYS"
          if (-not (az deployment sub create --name $deployName --location "$env:DEPLOYMENT_LOCATION" --template-file main.bicep --parameters @main-params.json -o json > gh-deployment.json)) { exit 1 }
          $outputs = az deployment sub show --name $deployName --query properties.outputs -o json | ConvertFrom-Json
          $outputs | ConvertTo-Json -Depth 10 | Out-File gh-deployment-outputs.json -Encoding utf8
          echo "Vaults: $($outputs.vaultIds.value -join ', ')"
          echo "Policies: $($outputs.backupPolicyNames.value -join ', ')"
          echo "UAIs: $($outputs.userAssignedIdentityIds.value -join ', ')"
          echo "Principals: $($outputs.userAssignedIdentityPrincipalIds.value -join ', ')"

      - name: Deploy auto-enable policy (DeployIfNotExists)
        if: ${{ env.ENABLE_AUTO_REMEDIATION == 'true' }}
        shell: pwsh
        run: |
          az account set --subscription "$env:SUBSCRIPTION_ID"
          $vaultName = "rsv-$env:DEPLOYMENT_LOCATION"
          $vaultRg   = "rsv-rg-$env:DEPLOYMENT_LOCATION"
          $policyName = "backup-policy-$env:DEPLOYMENT_LOCATION"
          echo "Deploying remediation policy for tag $env:VM_TAG_NAME=$env:VM_TAG_VALUE"
          pwsh ./scripts/Deploy-AutoEnablePolicySubscription.ps1 -SubscriptionId "$env:SUBSCRIPTION_ID" -Location "$env:DEPLOYMENT_LOCATION" -VmTagName "$env:VM_TAG_NAME" -VmTagValue "$env:VM_TAG_VALUE" -BackupPolicyName $policyName -VaultName $vaultName -VaultResourceGroup $vaultRg -CreateVault:$false
