name: Deploy Multi-Region VM Backup

on:
  workflow_dispatch:
    inputs:
      subscriptionId:
        description: 'Azure Subscription ID'
        required: true
      enableAutoRemediation:
        description: 'Enable Auto-Remediation (DeployIfNotExists)'
        required: false
        default: 'false'
        type: choice
        options: ['true','false']
      deploymentLocation:
        description: 'Subscription deployment metadata location'
        required: false
        default: 'westeurope'
        type: choice
        options: ['westeurope','northeurope','swedencentral','germanywestcentral']
      weeklyBackupDaysOfWeek:
        description: 'Weekly backup days (comma separated)'
        required: false
        default: 'Sunday,Wednesday'
      backupFrequency:
        description: 'Backup frequency'
        required: false
        default: 'Daily'
        type: choice
        options: ['Daily','Weekly','Both']
      dailyRetentionDays:
        description: 'Daily retention days'
        required: false
        default: '14'
      weeklyRetentionDays:
        description: 'Weekly retention days'
        required: false
        default: '30'
      backupScheduleTime:
        description: 'Backup schedule time (HH:mm)'
        required: false
        default: '18:30'
      backupTimeZone:
        description: 'Backup schedule time zone'
        required: false
        default: 'UTC'
      instantRestoreRetentionDays:
        description: 'Instant restore retention (days)'
        required: false
        default: '2'
      waitMinutesBeforeRemediation:
        description: 'Wait minutes before remediation (buffer after deploy)'
        required: false
        default: '5'
      enableMonthlyRetention:
        description: 'Enable monthly retention (Weekly policy only)'
        required: false
        default: 'false'
        type: choice
        options: ['true','false']
      monthlyRetentionMonths:
        description: 'Monthly retention (months)'
        required: false
        default: '60'
      monthlyWeeksOfMonth:
        description: "Monthly weeks (e.g. 'First' or 'First,Last')"
        required: false
        default: 'First'
      monthlyDaysOfWeek:
        description: "Monthly days (e.g. 'Sunday' or 'Sunday,Wednesday')"
        required: false
        default: 'Sunday'
      enableYearlyRetention:
        description: 'Enable yearly retention (Weekly policy only)'
        required: false
        default: 'false'
        type: choice
        options: ['true','false']
      yearlyRetentionYears:
        description: 'Yearly retention (years)'
        required: false
        default: '10'
      yearlyMonthsOfYear:
        description: "Yearly months (e.g. 'January,February,March')"
        required: false
        default: 'January,February,March'
      yearlyWeeksOfMonth:
        description: "Yearly weeks (e.g. 'First')"
        required: false
        default: 'First'
      yearlyDaysOfWeek:
        description: "Yearly days (e.g. 'Sunday')"
        required: false
        default: 'Sunday'
      vmTagName:
        description: 'Tag name used to select VMs for remediation'
        required: false
        default: 'backup'
      vmTagValue:
        description: 'Tag value used to select VMs for remediation'
        required: false
        default: 'true'

jobs:
  deploy:
    runs-on: windows-latest
    env:
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      ENABLE_AUTO_REMEDIATION: ${{ github.event.inputs.enableAutoRemediation }}
      DEPLOYMENT_LOCATION: ${{ github.event.inputs.deploymentLocation }}
      WEEKLY_DAYS: ${{ github.event.inputs.weeklyBackupDaysOfWeek }}
      BACKUP_FREQUENCY: ${{ github.event.inputs.backupFrequency }}
      DAILY_RETENTION: ${{ github.event.inputs.dailyRetentionDays }}
      WEEKLY_RETENTION: ${{ github.event.inputs.weeklyRetentionDays }}
      VM_TAG_NAME: ${{ github.event.inputs.vmTagName }}
      VM_TAG_VALUE: ${{ github.event.inputs.vmTagValue }}
      BACKUP_TIME: ${{ github.event.inputs.backupScheduleTime }}
      BACKUP_TZ: ${{ github.event.inputs.backupTimeZone }}
      INSTANT_RESTORE_DAYS: ${{ github.event.inputs.instantRestoreRetentionDays }}
      ENABLE_MONTHLY: ${{ github.event.inputs.enableMonthlyRetention }}
      MONTHLY_MONTHS: ${{ github.event.inputs.monthlyRetentionMonths }}
      MONTHLY_WEEKS: ${{ github.event.inputs.monthlyWeeksOfMonth }}
      MONTHLY_DAYS: ${{ github.event.inputs.monthlyDaysOfWeek }}
      ENABLE_YEARLY: ${{ github.event.inputs.enableYearlyRetention }}
      YEARLY_YEARS: ${{ github.event.inputs.yearlyRetentionYears }}
      YEARLY_MONTHS: ${{ github.event.inputs.yearlyMonthsOfYear }}
      YEARLY_WEEKS: ${{ github.event.inputs.yearlyWeeksOfMonth }}
      YEARLY_DAYS: ${{ github.event.inputs.yearlyDaysOfWeek }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.serivcon }}

      - name: Bicep build (syntax check)
        shell: pwsh
        run: |
          try { az bicep version | Out-Null } catch { az bicep install }
          az bicep build --file main.bicep --outdir bicep-build

      - name: Deploy multi-region backup (subscription scope)
        shell: pwsh
        run: |
          az account set --subscription "$env:SUBSCRIPTION_ID"
          $days = $env:WEEKLY_DAYS.Split(',') | ForEach-Object { $_.Trim() }
          $paramObj = @{
            backupFrequency        = @{ value = $env:BACKUP_FREQUENCY }
            dailyRetentionDays     = @{ value = [int]$env:DAILY_RETENTION }
            weeklyRetentionDays    = @{ value = [int]$env:WEEKLY_RETENTION }
            weeklyBackupDaysOfWeek = @{ value = $days }
            backupScheduleRunTimes = @{ value = @($env:BACKUP_TIME) }
            backupTimeZone         = @{ value = $env:BACKUP_TZ }
            instantRestoreRetentionDays = @{ value = [int]$env:INSTANT_RESTORE_DAYS }
            enableMonthlyRetention = @{ value = ($env:ENABLE_MONTHLY -eq 'true') }
            monthlyRetentionMonths = @{ value = [int]$env:MONTHLY_MONTHS }
            monthlyWeeksOfMonth    = @{ value = ($env:MONTHLY_WEEKS.Split(',') | ForEach-Object { $_.Trim() }) }
            monthlyDaysOfWeek      = @{ value = ($env:MONTHLY_DAYS.Split(',') | ForEach-Object { $_.Trim() }) }
            enableYearlyRetention  = @{ value = ($env:ENABLE_YEARLY -eq 'true') }
            yearlyRetentionYears   = @{ value = [int]$env:YEARLY_YEARS }
            yearlyMonthsOfYear     = @{ value = ($env:YEARLY_MONTHS.Split(',') | ForEach-Object { $_.Trim() }) }
            yearlyWeeksOfMonth     = @{ value = ($env:YEARLY_WEEKS.Split(',') | ForEach-Object { $_.Trim() }) }
            yearlyDaysOfWeek       = @{ value = ($env:YEARLY_DAYS.Split(',') | ForEach-Object { $_.Trim() }) }
          }
          $paramObj | ConvertTo-Json -Depth 5 | Out-File main-params.json -Encoding utf8
          $deployName = "gh-multi-region-$(Get-Date -Format yyyyMMddHHmmss)"
          echo "Starting deployment $deployName with frequency=$env:BACKUP_FREQUENCY days=$env:WEEKLY_DAYS"
          if (-not (az deployment sub create --name $deployName --location "$env:DEPLOYMENT_LOCATION" --template-file main.bicep --parameters @main-params.json -o json > gh-deployment.json)) { exit 1 }
          $outputs = az deployment sub show --name $deployName --query properties.outputs -o json | ConvertFrom-Json
          $outputs | ConvertTo-Json -Depth 10 | Out-File gh-deployment-outputs.json -Encoding utf8
          echo "Vaults: $($outputs.vaultIds.value -join ', ')"
          echo "Policies: $($outputs.backupPolicyNames.value -join ', ')"
          echo "UAIs: $($outputs.userAssignedIdentityIds.value -join ', ')"
          echo "Principals: $($outputs.userAssignedIdentityPrincipalIds.value -join ', ')"

  remediate:
    if: ${{ inputs.enableAutoRemediation == 'true' }}
    needs: deploy
    runs-on: windows-latest
    env:
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      DEPLOYMENT_LOCATION: ${{ github.event.inputs.deploymentLocation }}
      BACKUP_FREQUENCY: ${{ github.event.inputs.backupFrequency }}
      VM_TAG_NAME: ${{ github.event.inputs.vmTagName }}
      VM_TAG_VALUE: ${{ github.event.inputs.vmTagValue }}
      WAIT_MINUTES: ${{ github.event.inputs.waitMinutesBeforeRemediation }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.serivcon }}

      - name: Remediate tagged VMs (baseline region)
        shell: pwsh
        run: |
          az account set --subscription "$env:SUBSCRIPTION_ID"

          $wait = [int]$env:WAIT_MINUTES
          if ($wait -gt 0) { Write-Host "Waiting $wait minute(s) before remediation..."; Start-Sleep -Seconds ($wait * 60) }

          $r = $env:DEPLOYMENT_LOCATION
          $vaultName = "rsv-$r"
          $vaultRg   = "rsv-rg-$r"
          $basePolicyName = "backup-policy-$r"
          if ($env:BACKUP_FREQUENCY -eq 'Both') { $policyName = "$basePolicyName-weekly" } else { $policyName = $basePolicyName }
          $uaiId = "/subscriptions/$env:SUBSCRIPTION_ID/resourceGroups/$vaultRg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-$r"

          echo "Deploying policy assignment for region=$r vault=$vaultName policy=$policyName"
          az deployment sub create `
            --name "remediate-policy-$r-$(Get-Date -Format yyyyMMddHHmmss)" `
            --location $r `
            --template-file modules/backupAutoEnablePolicy.bicep `
            --parameters `
              assignmentLocation=$r `
              assignmentIdentityId=$uaiId `
              vmTagName=$env:VM_TAG_NAME `
              vmTagValue=$env:VM_TAG_VALUE `
              vaultName=$vaultName `
              vaultResourceGroup=$vaultRg `
              backupPolicyName=$policyName `
            -o none

          $assign = az policy assignment show -n enable-vm-backup-assignment -o json | ConvertFrom-Json
          if ($null -ne $assign) {
            $remName = "remediate-vm-backup-$r"
            echo "Starting remediation: $remName"
            az policy remediation create -n $remName --policy-assignment $assign.id --resource-discovery-mode ExistingNonCompliant -o none
          } else {
            echo "Warning: Policy assignment not found after deployment in region $r"
          }
          
