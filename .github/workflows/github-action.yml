name: Deploy Multi-Region VM Backup

on:
  workflow_dispatch:
    inputs:
      subscriptionId:
        description: 'Azure Subscription ID'
        required: true
      enableAutoRemediation:
        description: 'Enable Auto-Remediation (DeployIfNotExists)'
        required: false
        default: 'false'
        type: choice
        options: ['true','false']
      deploymentLocation:
        description: 'Subscription deployment metadata location'
        required: false
        default: 'westeurope'
        type: choice
        options: ['westeurope','northeurope','swedencentral','germanywestcentral']
      weeklyBackupDaysOfWeek:
        description: 'Weekly backup days (comma separated)'
        required: false
        default: 'Sunday,Wednesday'
      retentionProfile:
        description: 'Composite: Daily|Weekly|Yearly|TagName|TagValue (Yearly=0 disables yearly tier)'
        required: false
        default: '14|30|0|backup|true'
      backupFrequency:
        description: 'Backup frequency'
        required: false
        default: 'Weekly'
        type: choice
        options: ['Daily','Weekly','Both']
      backupScheduleTime:
        description: 'Backup schedule time (HH:mm) increments of 30 minutes'
        required: false
        default: '18:30'
      backupTimeZone:
        description: 'Backup schedule time zone (Windows Time Zone ID)'
        required: false
        default: 'UTC'
        type: choice
        options:
          - 'UTC'
          - 'Central Europe Standard Time'
      remediationRegions:
        description: 'Comma-separated regions to remediate (empty -> deploymentLocation)'
        required: false
        default: ''
      instantRestoreRetentionDays:
        description: 'Instant restore retention (days). Weekly or Both: weekly policy uses 5; daily uses this value (1â€“5).'
        required: false
        default: '2'
        type: choice
        options: ['1','2','3','4','5']

jobs:
  deploy:
    runs-on: windows-latest
    outputs:
      vmTagName: ${{ steps.deploy_backup.outputs.vmTagName }}
      vmTagValue: ${{ steps.deploy_backup.outputs.vmTagValue }}
    env:
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      ENABLE_AUTO_REMEDIATION: ${{ github.event.inputs.enableAutoRemediation }}
      DEPLOYMENT_LOCATION: ${{ github.event.inputs.deploymentLocation }}
      WEEKLY_DAYS: ${{ github.event.inputs.weeklyBackupDaysOfWeek }}
      BACKUP_FREQUENCY: ${{ github.event.inputs.backupFrequency }}
      RETENTION_PROFILE: ${{ github.event.inputs.retentionProfile }}
      VM_TAG_NAME: ''
      VM_TAG_VALUE: ''
      BACKUP_TIME: ${{ github.event.inputs.backupScheduleTime }}
      BACKUP_TZ: ${{ github.event.inputs.backupTimeZone }}
      INSTANT_RESTORE_DAYS: ${{ github.event.inputs.instantRestoreRetentionDays }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.serivcon }}

      - name: Bicep build (syntax check)
        shell: pwsh
        run: |
          try { az bicep version | Out-Null } catch { az bicep install }
          az bicep build --file main.bicep --outdir bicep-build

      - name: Deploy multi-region backup (subscription scope)
        id: deploy_backup
        shell: pwsh
        run: |
          . ./scripts/Deploy-BackupInfra.ps1

  deploy_policy:
    needs: deploy
    if: ${{ github.event.inputs.enableAutoRemediation == 'true' }}
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.serivcon }}

      - name: Deploy policy definition (verbatim)
        shell: pwsh
        run: |
          $policyName = 'Custom-CentralVmBackup-AnyOS'
          $policyFile = 'policy-definitions/customCentralVmBackup.full.json'
          if (-not (Test-Path $policyFile)) { Write-Host "Policy file not found: $policyFile"; exit 0 }
          Write-Host "Creating policy definition $policyName from $policyFile (PUT via az rest)"
            $curSub = az account show --query id -o tsv
            $uri = "https://management.azure.com/subscriptions/$curSub/providers/Microsoft.Authorization/policyDefinitions/$policyName?api-version=2021-06-01"
            $resp = az rest --method put --uri $uri --body "@$policyFile" -o json 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Error "az rest failed: $resp"
              exit $LASTEXITCODE
            }
            Write-Host "Policy definition deployed (showing stored policyRule snippet)"
            az policy definition show -n $policyName --query properties.policyRule -o json

  remediate:
    if: ${{ github.event.inputs.enableAutoRemediation == 'true' }}
    needs: [deploy, deploy_policy]
    runs-on: windows-latest
    env:
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      DEPLOYMENT_LOCATION: ${{ github.event.inputs.deploymentLocation }}
      BACKUP_FREQUENCY: ${{ github.event.inputs.backupFrequency }}
      VM_TAG_NAME: ${{ needs.deploy.outputs.vmTagName }}
      VM_TAG_VALUE: ${{ needs.deploy.outputs.vmTagValue }}
      REMEDIATION_REGIONS: ${{ github.event.inputs.remediationRegions }}
      WAIT_MINUTES: '5'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.serivcon }}

      - name: Trigger remediation (per-region, no polling)
        shell: pwsh
        run: |
          . ./scripts/Start-BackupRemediation.ps1
          
