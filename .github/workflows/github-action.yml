name: Deploy Multi-Region VM Backup

on:
  workflow_dispatch:
    inputs:
      subscriptionId:
        description: 'Azure Subscription ID'
        required: true
      enableAutoRemediation:
        description: 'Enable Auto-Remediation (DeployIfNotExists)'
        required: false
        default: 'false'
        type: choice
        options: ['true','false']
      deploymentLocation:
        description: 'Subscription deployment metadata location'
        required: false
        default: 'westeurope'
        type: choice
        options: ['westeurope','northeurope','swedencentral','germanywestcentral']

jobs:
  deploy:
    runs-on: windows-latest
    env:
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      ENABLE_AUTO_REMEDIATION: ${{ github.event.inputs.enableAutoRemediation }}
      DEPLOYMENT_LOCATION: ${{ github.event.inputs.deploymentLocation }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.serivcon }}

      - name: Bicep build (syntax check)
        shell: pwsh
        run: |
          try { az bicep version | Out-Null } catch { az bicep install }
          az bicep build --file main.bicep --outdir bicep-build

      - name: Deploy multi-region backup (subscription scope)
        shell: pwsh
        run: |
          az account set --subscription "$env:SUBSCRIPTION_ID"
          az deployment sub create --location "$env:DEPLOYMENT_LOCATION" --template-file main.bicep

      - name: Deploy auto-enable policy (DeployIfNotExists)
        if: ${{ env.ENABLE_AUTO_REMEDIATION == 'true' }}
        shell: pwsh
        run: |
          az account set --subscription "$env:SUBSCRIPTION_ID"
          pwsh ./scripts/Deploy-AutoEnablePolicySubscription.ps1 -SubscriptionId "$env:SUBSCRIPTION_ID" -Location "$env:DEPLOYMENT_LOCATION" -VmTagName "backup" -VmTagValue "true" -BackupPolicyName "backup-policy-westeurope" -VaultName "rsv-westeurope" -VaultResourceGroup "rsv-rg-westeurope" -CreateVault:$false
