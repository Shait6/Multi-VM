name: Remediate VM Backup Policy

on:
  workflow_dispatch:
    inputs:
      subscriptionId:
        description: 'Azure Subscription ID'
        required: true
      multiRegionAutoRemediation:
        description: 'Remediate all regions'
        required: false
        default: 'false'
        type: choice
        options: ['true','false']
      policyBaselineRegion:
        description: 'Baseline region when not remediating all'
        required: false
        default: 'westeurope'
        type: choice
        options: ['westeurope','northeurope','swedencentral','germanywestcentral']
      vmTagName:
        description: 'VM tag name to select VMs'
        required: false
        default: 'backup'
      vmTagValue:
        description: 'VM tag value to select VMs'
        required: false
        default: 'true'
      waitMinutes:
        description: 'Wait minutes before remediation starts'
        required: false
        default: '5'

jobs:
  remediate:
    runs-on: windows-latest
    env:
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      MULTI_REGION: ${{ github.event.inputs.multiRegionAutoRemediation }}
      BASELINE_REGION: ${{ github.event.inputs.policyBaselineRegion }}
      VM_TAG_NAME: ${{ github.event.inputs.vmTagName }}
      VM_TAG_VALUE: ${{ github.event.inputs.vmTagValue }}
      WAIT_MINUTES: ${{ github.event.inputs.waitMinutes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Remediate tagged VMs
        shell: pwsh
        run: |
          az account set --subscription "$env:SUBSCRIPTION_ID"

          $wait = [int]$env:WAIT_MINUTES
          if ($wait -gt 0) { Write-Host "Waiting $wait minute(s) before remediation..."; Start-Sleep -Seconds ($wait * 60) }

          $allRegions = @('westeurope','northeurope','swedencentral','germanywestcentral')
          $targetRegions = if ($env:MULTI_REGION -eq 'true') { $allRegions } else { @($env:BASELINE_REGION) }

          foreach ($r in $targetRegions) {
            $vaultName = "rsv-$r"
            $vaultRg   = "rsv-rg-$r"
            $policyName = "backup-policy-$r"
            $uaiId = "/subscriptions/$env:SUBSCRIPTION_ID/resourceGroups/$vaultRg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/uai-$r"

            echo "Deploying policy assignment for region=$r vault=$vaultName policy=$policyName"
            az deployment sub create `
              --name "remediate-policy-$r-$(Get-Date -Format yyyyMMddHHmmss)" `
              --location $r `
              --template-file modules/backupAutoEnablePolicy.bicep `
              --parameters `
                assignmentLocation=$r `
                assignmentIdentityId=$uaiId `
                vmTagName=$env:VM_TAG_NAME `
                vmTagValue=$env:VM_TAG_VALUE `
                vaultName=$vaultName `
                vaultResourceGroup=$vaultRg `
                backupPolicyName=$policyName `
              -o none

            $assign = az policy assignment show -n enable-vm-backup-assignment -o json | ConvertFrom-Json
            if ($null -ne $assign) {
              $remName = "remediate-vm-backup-$r"
              echo "Starting remediation: $remName"
              az policy remediation create -n $remName --policy-assignment $assign.id --resource-discovery-mode ExistingNonCompliant -o none
            } else {
              echo "Warning: Policy assignment not found after deployment in region $r"
            }
          }
