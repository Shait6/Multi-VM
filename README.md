# Azure VM Backup Automation

This repository automates deploying Recovery Services Vaults and Backup Policies for Azure VMs, and optionally enables automatic remediation so tagged VMs (for example those with tag `backup=true`) get protected automatically. The solution is intended to run from either GitHub Actions or Azure DevOps, and is built with Bicep + Azure CLI.

What's included (short)
- Parameter generation and normalization for backup schedules and retention.
- Bicep templates with a small set of modules to create vaults, backup policies, a user-assigned identity (UAI), and role assignments.
- An optional subscription-scoped DeployIfNotExists / remediation flow that uses the UAI to enable backup for existing unprotected VMs matching a tag.
- Example CI pipelines for GitHub Actions and Azure DevOps that run the full flow.

How the solution works (high level)
1. Generate parameters: `scripts/Set-DeploymentParameters.ps1` builds `main.parameters.json` from inputs and normalizes values (times, days, retention counts).
2. Validate & build: CI runs `az bicep build` and an ARM/Bicep validate to catch template issues early.
3. Group deployment: `main.bicep` deploys the Recovery Services Vault and backup policy resources into the chosen resource group and location. It also creates a user-assigned identity and returns its resource id and principal id as outputs.
4. Role assignment: CI ensures the UAI has the needed RBAC on the vault resource group (so remediation can create protected items).
5. Subscription assignment & remediation: CI runs a subscription-scoped deployment (`deploy-policy-subscription.bicep`) which creates the policy assignment using the UAI and a `Microsoft.PolicyInsights/remediations` resource to remediate existing non-compliant VMs.

File map — what each file does (short and human)
- `main.bicep` — top-level orchestrator: wires modules together and outputs useful IDs from the group deployment.
- `main.parameters.json` — generated by `Set-DeploymentParameters.ps1`; passed to `az deployment` so complex arrays and strings are reliable across shells.

- modules/
	- `recoveryVault.bicep` — creates (or references) the Recovery Services Vault in the target RG and location.
	- `backupPolicy.bicep` — creates Daily and/or Weekly backup policy resources, with retention and schedule settings.
	- `userAssignedIdentity.bicep` — creates the user-assigned managed identity used by policy remediations; outputs resource id and principal id.
	- `roleAssignment.bicep` — helper to give the UAI Contributor rights on the vault RG (so remediation can create protected items).
	- `deploy-policy-subscription.bicep` — subscription-scoped template that creates the policy assignment and a remediation resource which runs against existing non-compliant VMs.
	- `backupAutoEnablePolicy.bicep` / `autoEnablePolicy.rule.json` — policy definition template and rule JSON used by the workflows to create the DeployIfNotExists definition (the workflow replaces placeholders like vault name and role definition id before creating the policy).

- scripts/
	- `Set-DeploymentParameters.ps1` — central parameter generator (normalize schedule times/days, compute retention values, write `main.parameters.json`).
	- `Create-ResourceGroup.ps1` — idempotent RG creation helper used by CI.
	- `Deploy-Backup.ps1` — small wrapper used by the Azure DevOps pipeline to run the group deployment.
	- `Wait-For-AadPrincipal.ps1` — helper to poll AAD until a service principal for the UAI exists (used to avoid PrincipalNotFound timing errors).
	- `Deploy-AutoEnablePolicySubscription.ps1` / `Deploy-AuditPolicy.ps1` — legacy/scripted alternatives for policy creation (the pipelines use a param-file + `az deployment sub create` or direct `az policy` commands depending on flow).

- CI pipelines
	- `.github/workflows/deploy.yml` — GitHub Actions: parameter generation, bicep build validation, group deployment, role assignment for the UAI, and a subscription deployment to create the policy assignment/remediation. Implemented to avoid shell quoting/path mangling on Windows runners by using PowerShell for param file creation and passing the parameters file to `az`.
	- `azure-pipelines.yml` — Azure DevOps: mirrors the same flow using `AzurePowerShell@5` and `AzureCLI@2` tasks. The pipeline also writes a parameters JSON and uses PowerShell inline scripts for steps that pass resource ids.
	- `azure-pipelines-audit.yml` — an optional pipeline for management-group scoped audits (keeps audits separate from infra deployment).

Important operational notes and gotchas
- Vaults are regional. To protect a VM you must create the RSV in the same region as the VM. If you have VMs in multiple regions you must either create multiple vaults (one per region) or make the remediation template create/target a vault in the VM's region (using `field('location')`).
- MSYS/Git Bash path mangling: on Windows runners, leading-slash resource ids like `/subscriptions/...` can be turned into `C:/Program Files/Git/...` by MSYS. To avoid this, the pipelines pass parameters via a JSON file written by PowerShell and call `az ... --parameters "@file.json"`.
- AAD propagation: after creating a user-assigned identity ARM resource, its service principal can take a short while to appear in AAD. The pipelines use `Wait-For-AadPrincipal.ps1` and a retry/backoff when creating the subscription-scoped deployment to reduce intermittent IdentityServiceUnavailable or PrincipalNotFound failures.
- Permissions: creating policy definitions, assignments and remediations requires elevated rights (Policy Contributor or Owner). Creating role assignments may require User Access Administrator or Owner. Ensure your CI service principal has the necessary roles.

Quick validation steps (local)
1) Regenerate parameters (PowerShell):

```powershell
.
\scripts\Set-DeploymentParameters.ps1 `
	-Location 'eastus' `
	-SubscriptionId '<SUB_ID>' `
	-VaultName 'rsv-backup-test' `
	-BackupPolicyName 'DefaultPolicy' `
	-DailyRetentionDays 14 `
	-WeeklyRetentionDays 30 `
	-BackupScheduleRunTimes @('01:00') `
	-WeeklyBackupDaysOfWeek @('Sunday','Wednesday') `
	-IncludeLocation
```

2) Validate the group deployment (PowerShell-safe parameters quoting):

```powershell
az account set --subscription <SUB_ID>
az deployment group validate --resource-group <RG_NAME> --template-file main.bicep --parameters "@main.parameters.json"
```

If validation fails, capture the full JSON output for the failing operation (the provider `statusMessage`) and use it to pinpoint which property the Recovery Services API expects.

Troubleshooting tips
- If you see IdentityServiceUnavailable or PrincipalNotFound errors, re-run the `az ad sp show --id <principalId>` command from the same credentials used by CI — if it returns not-found, wait/poll until it exists and retry the subscription deployment.
- If you see InvalidDeploymentLocation for `assign-policy`, it usually means a previous subscription deployment with the same name exists in a different region. Either delete the old subscription deployment (`az deployment sub delete --name assign-policy`) or configure the pipeline to use a unique deployment name per run.

How to extend or adapt
- Multi-region: either pre-create a vault per region and teach the remediation to pick the regional vault, or modify the remediation template to deploy the vault into the resource's region using `field('location')`.
- Least privilege: instead of granting Contributor on the entire subscription you can limit the UAI's Contributor role to specific vault resource groups.

If you'd like, I can help make any of the following small, safe edits:
- Make subscription deployment names unique per run to avoid location conflicts.
- Harden retries to only retry for identity-related errors.
- Add a short diagnostic output on failure that prints `az deployment sub operation list --name <deploy>` to capture provider `statusMessage` for debugging.

That's a concise overview — if you want, tell me which small change above to make and I'll apply it and validate the pipeline files.
