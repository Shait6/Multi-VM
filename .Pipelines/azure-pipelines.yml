parameters:
  - name: serviceConnection
    type: string
    default: 'bicep_deploy_SC'
    displayName: 'Azure Service Connection'
  - name: subscriptionId
    type: string
    default: ''
    displayName: 'Target Subscription Id (blank -> service connection default)'
  - name: deploymentLocation
    type: string
    values:
      - westeurope
      - northeurope
      - swedencentral
      - germanywestcentral
    default: westeurope
    displayName: 'Subscription Deployment Location'
  - name: backupFrequency
    type: string
    values:
      - Daily
      - Weekly
      - Both
    default: Weekly
    displayName: 'Backup Frequency'
  - name: retentionProfile
    type: string
    default: '14|30|0|backup|true'
    displayName: 'Retention Profile Daily|Weekly|Yearly|TagName|TagValue (Yearly=0 disables yearly tier)'
  - name: weeklyBackupDaysOfWeek
    type: string
    default: 'Sunday,Wednesday'
    displayName: 'Weekly Backup Days (comma separated)'
  - name: backupScheduleTime
    type: string
    default: '18:30'
    displayName: 'Backup schedule time (HH:mm)'
  - name: backupTimeZone
    type: string
    values:
      - 'UTC'
      - 'Central Europe Standard Time'
    default: 'UTC'
    displayName: 'Backup Time Zone (Windows Time Zone ID)'
  - name: instantRestoreRetentionDays
    type: string
    values: ['1','2','3','4','5']
    default: '2'
    displayName: 'Instant Restore Retention Days (1..5)'
  - name: enableMonthlyRetention
    type: string
    values: ['true','false']
    default: 'false'
    displayName: 'Enable Monthly Tier'
  - name: monthlyRetentionMonths
    type: number
    default: 0
    displayName: 'Monthly Retention (months)'
  - name: monthlyWeeksOfMonth
    type: string
    default: 'First'
    displayName: 'Monthly Weeks Of Month'
  - name: monthlyDaysOfWeek
    type: string
    default: 'Sunday'
    displayName: 'Monthly Days Of Week'
  - name: yearlyMonthsOfYear
    type: string
    default: 'January'
    displayName: 'Yearly Months Of Year'
  - name: yearlyWeeksOfMonth
    type: string
    default: 'First'
    displayName: 'Yearly Weeks Of Month'
  - name: yearlyDaysOfWeek
    type: string
    default: 'Sunday'
    displayName: 'Yearly Days Of Week'
  - name: enableAutoRemediation
    type: string
    values: ['true','false']
    default: 'false'
    displayName: 'Enable Auto-Remediation (DeployIfNotExists)'
  - name: remediationRegions
    type: string
    default: ''
    displayName: 'Comma-separated regions to remediate (empty -> deploymentLocation)'
  - name: waitMinutesBeforeRemediation
    type: number
    default: 5
    displayName: 'Minutes to wait before remediation'

stages:
  - stage: BuildAndDeploy
    displayName: 'Build & Deploy Backup Infrastructure'
    jobs:
      - job: BuildDeploy
        displayName: 'Build Bicep and Deploy'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: 'Bicep Build (syntax)'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                try { az bicep version | Out-Null } catch { az bicep install }
                az bicep build --file main.bicep --outdir bicep-build
          - task: AzureCLI@2
            displayName: 'Subscription Deployment'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                if (-not [string]::IsNullOrWhiteSpace('${{ parameters.subscriptionId }}')) { $env:SUBSCRIPTION_ID='${{ parameters.subscriptionId }}' }
                $env:DEPLOYMENT_LOCATION = '${{ parameters.deploymentLocation }}'
                $env:BACKUP_FREQUENCY    = '${{ parameters.backupFrequency }}'
                $env:WEEKLY_DAYS         = '${{ parameters.weeklyBackupDaysOfWeek }}'
                $env:RETENTION_PROFILE   = '${{ parameters.retentionProfile }}'
                $env:BACKUP_TIME         = '${{ parameters.backupScheduleTime }}'
                $env:BACKUP_TZ           = '${{ parameters.backupTimeZone }}'
                $env:INSTANT_RESTORE_DAYS= '${{ parameters.instantRestoreRetentionDays }}'
                . ./scripts/Deploy-BackupInfra.ps1
  - stage: DeployPolicyDefinition
    displayName: 'Deploy Policy Definition'
    dependsOn: BuildAndDeploy
    jobs:
      - job: DeployPolicy
        displayName: 'Create/Update Custom Policy Definition'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: 'Deploy policy definition (verbatim)'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $subId = '${{ parameters.subscriptionId }}'
                if (-not [string]::IsNullOrWhiteSpace($subId)) { az account set --subscription $subId }
                $policyName = 'Custom-CentralVmBackup'
                $policyFile = 'policy-definitions/customCentralVmBackup.full.json'
                if (-not (Test-Path $policyFile)) { Write-Host "Policy file not found: $policyFile"; exit 0 }
                Write-Host "Creating policy definition $policyName from $policyFile (PUT via az rest)"
                $curSub = az account show --query id -o tsv
                  $rulesFile = 'policy-definitions/customCentralVmBackup.rules.json'
                  $fullFile = 'policy-definitions/customCentralVmBackup.full.json'
                  if (-not (Test-Path $rulesFile)) { Write-Host "Rules file not found: $rulesFile"; exit 0 }
                  Write-Host "Creating policy definition $policyName from rules file $rulesFile"
                  $paramsArg = $null
                  if (Test-Path $fullFile) {
                    try {
                      $raw = Get-Content -Raw -Path $fullFile | ConvertFrom-Json
                      if ($raw.properties -and $raw.properties.parameters) {
                        $tmpParams = [System.IO.Path]::GetTempFileName() + '.json'
                        $raw.properties.parameters | ConvertTo-Json -Depth 99 | Out-File -FilePath $tmpParams -Encoding utf8
                        $paramsArg = $tmpParams
                      }
                    } catch {
                      Write-Warning "Failed to parse full JSON params: $($_.Exception.Message)"
                    }
                  }
                  try {
                    if ($paramsArg) {
                      az policy definition create --name $policyName --display-name "Central VM Backup" --description "Any tagged VM in region backed up to vault using specified policy." --rules $rulesFile --params $paramsArg --mode Indexed -o json
                    } else {
                      az policy definition create --name $policyName --display-name "Central VM Backup" --description "Any tagged VM in region backed up to vault using specified policy." --rules $rulesFile --mode Indexed -o json
                    }
                  } finally {
                    if ($paramsArg -and (Test-Path $paramsArg)) { Remove-Item $paramsArg -Force }
                  }
                  Write-Host "Policy definition created. Showing stored policyRule snippet"
                  az policy definition show -n $policyName --query properties.policyRule -o json | ConvertFrom-Json | ConvertTo-Json -Depth 6
  - stage: Remediate
    displayName: 'Auto-enable Backup Remediation'
    dependsOn: DeployPolicyDefinition
    condition: and(succeeded(), eq('${{ parameters.enableAutoRemediation }}','true'))
    jobs:
      - job: RemediateTaggedVMs
        displayName: 'Run Remediation Script'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: 'Trigger Remediation (no polling)'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $subId = '${{ parameters.subscriptionId }}'
                if (-not [string]::IsNullOrWhiteSpace($subId)) { az account set --subscription $subId }
                $env:REMEDIATION_REGIONS = '${{ parameters.remediationRegions }}'
                $env:DEPLOYMENT_LOCATION = '${{ parameters.deploymentLocation }}'
                $env:BACKUP_FREQUENCY    = '${{ parameters.backupFrequency }}'
                # Parse tags from composite retention profile
                $parts = "${{ parameters.retentionProfile }}".Split('|')
                if ($parts.Count -ge 5) { $env:VM_TAG_NAME = $parts[3]; $env:VM_TAG_VALUE = $parts[4] }
                . ./scripts/Start-BackupRemediation.ps1
          

