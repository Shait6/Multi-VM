{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "1472275810705593193"
    }
  },
  "parameters": {
    "backupScheduleRunTimes": {
      "type": "array",
      "defaultValue": [
        "01:00"
      ],
      "metadata": {
        "description": "Backup schedule run times (UTC HH:mm) applied to all region policies"
      }
    },
    "dailyRetentionDays": {
      "type": "int",
      "defaultValue": 14,
      "minValue": 7,
      "metadata": {
        "description": "Daily retention in days (>=7)"
      }
    },
    "weeklyRetentionDays": {
      "type": "int",
      "defaultValue": 30,
      "minValue": 7,
      "metadata": {
        "description": "Weekly retention in days (>=7; converted to weeks internally)"
      }
    },
    "weeklyBackupDaysOfWeek": {
      "type": "array",
      "defaultValue": [
        "Sunday",
        "Wednesday"
      ],
      "metadata": {
        "description": "Days of week for weekly backups"
      }
    },
    "backupFrequency": {
      "type": "string",
      "defaultValue": "Daily",
      "allowedValues": [
        "Daily",
        "Weekly",
        "Both"
      ],
      "metadata": {
        "description": "Backup frequency for VM policies across regions"
      }
    },
    "backupTimeZone": {
      "type": "string",
      "defaultValue": "UTC",
      "metadata": {
        "description": "Backup schedule timezone (e.g., UTC)"
      }
    },
    "instantRestoreRetentionDays": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Instant Restore snapshot retention in days"
      }
    },
    "enableMonthlyRetention": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable additional monthly retention tier (for weekly policy)"
      }
    },
    "monthlyRetentionMonths": {
      "type": "int",
      "defaultValue": 60,
      "metadata": {
        "description": "Monthly retention duration in months"
      }
    },
    "monthlyWeeksOfMonth": {
      "type": "array",
      "defaultValue": [
        "First"
      ],
      "metadata": {
        "description": "Monthly retention weeks of the month"
      }
    },
    "monthlyDaysOfWeek": {
      "type": "array",
      "defaultValue": [
        "Sunday"
      ],
      "metadata": {
        "description": "Monthly retention days of the week"
      }
    },
    "enableYearlyRetention": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable additional yearly retention tier (for weekly policy)"
      }
    },
    "yearlyRetentionYears": {
      "type": "int",
      "defaultValue": 10,
      "metadata": {
        "description": "Yearly retention duration in years"
      }
    },
    "yearlyMonthsOfYear": {
      "type": "array",
      "defaultValue": [
        "January",
        "February",
        "March"
      ],
      "metadata": {
        "description": "Yearly retention months of year"
      }
    },
    "yearlyWeeksOfMonth": {
      "type": "array",
      "defaultValue": [
        "First"
      ],
      "metadata": {
        "description": "Yearly retention weeks of the month"
      }
    },
    "yearlyDaysOfWeek": {
      "type": "array",
      "defaultValue": [
        "Sunday"
      ],
      "metadata": {
        "description": "Yearly retention days of the week"
      }
    },
    "publicNetworkAccess": {
      "type": "string",
      "defaultValue": "Enabled",
      "allowedValues": [
        "Enabled",
        "Disabled"
      ],
      "metadata": {
        "description": "Public network access setting for vaults"
      }
    },
    "vaultSkuName": {
      "type": "string",
      "defaultValue": "RS0",
      "metadata": {
        "description": "Recovery Services Vault SKU name"
      }
    },
    "vaultSkuTier": {
      "type": "string",
      "defaultValue": "Standard",
      "metadata": {
        "description": "Recovery Services Vault SKU tier"
      }
    },
    "remediationRoleDefinitionId": {
      "type": "string",
      "defaultValue": "b24988ac-6180-42a0-ab88-20f7382dd24c",
      "metadata": {
        "description": "Role Definition ID or GUID for remediation identity ( Contributor )"
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "rgNames",
        "count": "[length(variables('regions'))]",
        "input": "[format('rsv-rg-{0}', variables('regions')[copyIndex('rgNames')])]"
      },
      {
        "name": "vaultNames",
        "count": "[length(variables('regions'))]",
        "input": "[format('rsv-{0}', variables('regions')[copyIndex('vaultNames')])]"
      },
      {
        "name": "uaiNames",
        "count": "[length(variables('regions'))]",
        "input": "[format('uai-{0}', variables('regions')[copyIndex('uaiNames')])]"
      },
      {
        "name": "backupPolicyNames",
        "count": "[length(variables('regions'))]",
        "input": "[format('backup-policy-{0}', variables('regions')[copyIndex('backupPolicyNames')])]"
      }
    ],
    "regions": [
      "westeurope",
      "northeurope",
      "swedencentral",
      "germanywestcentral"
    ]
  },
  "resources": [
    {
      "copy": {
        "name": "rgs",
        "count": "[length(variables('regions'))]"
      },
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('rgNames')[copyIndex()]]",
      "location": "[variables('regions')[copyIndex()]]"
    },
    {
      "copy": {
        "name": "vaults",
        "count": "[length(variables('regions'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('recoveryVaultModule-{0}', variables('regions')[copyIndex()])]",
      "resourceGroup": "[variables('rgNames')[copyIndex()]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vaultName": {
            "value": "[variables('vaultNames')[copyIndex()]]"
          },
          "location": {
            "value": "[variables('regions')[copyIndex()]]"
          },
          "publicNetworkAccess": {
            "value": "[parameters('publicNetworkAccess')]"
          },
          "skuName": {
            "value": "[parameters('vaultSkuName')]"
          },
          "skuTier": {
            "value": "[parameters('vaultSkuTier')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16504792638812176306"
            }
          },
          "parameters": {
            "vaultName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Recovery Services Vault"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the vault"
              }
            },
            "skuName": {
              "type": "string",
              "defaultValue": "RS0",
              "metadata": {
                "description": "SKU name for the Recovery Services Vault (e.g. RS0)"
              }
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Standard",
              "metadata": {
                "description": "SKU tier for the Recovery Services Vault (e.g. Standard)"
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled",
              "allowedValues": [
                "Enabled",
                "Disabled"
              ]
            }
          },
          "resources": [
            {
              "type": "Microsoft.RecoveryServices/vaults",
              "apiVersion": "2023-04-01",
              "name": "[parameters('vaultName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "properties": {
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "restoreSettings": {
                  "crossSubscriptionRestoreSettings": {
                    "crossSubscriptionRestoreState": "Enabled"
                  }
                }
              }
            }
          ],
          "outputs": {
            "vaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.RecoveryServices/vaults', parameters('vaultName'))]"
            },
            "vaultName": {
              "type": "string",
              "value": "[parameters('vaultName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgNames')[copyIndex()])]"
      ]
    },
    {
      "copy": {
        "name": "policies",
        "count": "[length(variables('regions'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('backupPolicyModule-{0}', variables('regions')[copyIndex()])]",
      "resourceGroup": "[variables('rgNames')[copyIndex()]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vaultName": {
            "value": "[variables('vaultNames')[copyIndex()]]"
          },
          "backupPolicyName": {
            "value": "[variables('backupPolicyNames')[copyIndex()]]"
          },
          "backupFrequency": {
            "value": "[parameters('backupFrequency')]"
          },
          "backupScheduleRunTimes": {
            "value": "[parameters('backupScheduleRunTimes')]"
          },
          "weeklyBackupDaysOfWeek": {
            "value": "[parameters('weeklyBackupDaysOfWeek')]"
          },
          "dailyRetentionDays": {
            "value": "[parameters('dailyRetentionDays')]"
          },
          "weeklyRetentionDays": {
            "value": "[parameters('weeklyRetentionDays')]"
          },
          "backupTimeZone": {
            "value": "[parameters('backupTimeZone')]"
          },
          "instantRestoreRetentionDays": {
            "value": "[parameters('instantRestoreRetentionDays')]"
          },
          "enableMonthlyRetention": {
            "value": "[parameters('enableMonthlyRetention')]"
          },
          "monthlyRetentionMonths": {
            "value": "[parameters('monthlyRetentionMonths')]"
          },
          "monthlyWeeksOfMonth": {
            "value": "[parameters('monthlyWeeksOfMonth')]"
          },
          "monthlyDaysOfWeek": {
            "value": "[parameters('monthlyDaysOfWeek')]"
          },
          "enableYearlyRetention": {
            "value": "[parameters('enableYearlyRetention')]"
          },
          "yearlyRetentionYears": {
            "value": "[parameters('yearlyRetentionYears')]"
          },
          "yearlyMonthsOfYear": {
            "value": "[parameters('yearlyMonthsOfYear')]"
          },
          "yearlyWeeksOfMonth": {
            "value": "[parameters('yearlyWeeksOfMonth')]"
          },
          "yearlyDaysOfWeek": {
            "value": "[parameters('yearlyDaysOfWeek')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6672222163403414838"
            }
          },
          "parameters": {
            "vaultName": {
              "type": "string",
              "metadata": {
                "description": "Parent Recovery Services Vault resource name"
              }
            },
            "backupPolicyName": {
              "type": "string",
              "metadata": {
                "description": "Name of the backup policy base (daily/weekly suffix added when Both)"
              }
            },
            "backupFrequency": {
              "type": "string",
              "defaultValue": "Daily",
              "allowedValues": [
                "Daily",
                "Weekly",
                "Both"
              ],
              "metadata": {
                "description": "Backup frequency: Daily, Weekly, or Both"
              }
            },
            "backupScheduleRunTimes": {
              "type": "array",
              "metadata": {
                "description": "Backup run times (UTC HH:mm)"
              }
            },
            "weeklyBackupDaysOfWeek": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Weekly run days (Weekly or Both)"
              }
            },
            "dailyRetentionDays": {
              "type": "int",
              "defaultValue": 14,
              "minValue": 7,
              "metadata": {
                "description": "Retention in days for daily backups (>=7)"
              }
            },
            "weeklyRetentionDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 7,
              "metadata": {
                "description": "Retention in days for weekly backups (>=7; converted to weeks)"
              }
            },
            "backupTimeZone": {
              "type": "string",
              "defaultValue": "UTC",
              "allowedValues": [
                "UTC",
                "Central Europe Standard Time"
              ],
              "metadata": {
                "description": "Time zone for schedule (Windows Time Zone ID)"
              }
            },
            "instantRestoreRetentionDays": {
              "type": "int",
              "defaultValue": 2
            },
            "enableMonthlyRetention": {
              "type": "bool",
              "defaultValue": false
            },
            "monthlyRetentionMonths": {
              "type": "int",
              "defaultValue": 60
            },
            "monthlyRetentionScheduleFormat": {
              "type": "string",
              "defaultValue": "Weekly"
            },
            "monthlyWeeksOfMonth": {
              "type": "array",
              "defaultValue": [
                "First"
              ]
            },
            "monthlyDaysOfWeek": {
              "type": "array",
              "defaultValue": [
                "Sunday"
              ]
            },
            "enableYearlyRetention": {
              "type": "bool",
              "defaultValue": false
            },
            "yearlyRetentionYears": {
              "type": "int",
              "defaultValue": 10
            },
            "yearlyRetentionScheduleFormat": {
              "type": "string",
              "defaultValue": "Weekly"
            },
            "yearlyMonthsOfYear": {
              "type": "array",
              "defaultValue": [
                "January",
                "February",
                "March"
              ]
            },
            "yearlyWeeksOfMonth": {
              "type": "array",
              "defaultValue": [
                "First"
              ]
            },
            "yearlyDaysOfWeek": {
              "type": "array",
              "defaultValue": [
                "Sunday"
              ]
            }
          },
          "variables": {
            "copy": [
              {
                "name": "isoRunTimes",
                "count": "[length(parameters('backupScheduleRunTimes'))]",
                "input": "[if(contains(parameters('backupScheduleRunTimes')[copyIndex('isoRunTimes')], 'T'), parameters('backupScheduleRunTimes')[copyIndex('isoRunTimes')], format('2016-09-21T{0}:00Z', parameters('backupScheduleRunTimes')[copyIndex('isoRunTimes')]))]"
              }
            ],
            "weeklyRetentionWeeks": "[int(div(add(parameters('weeklyRetentionDays'), 6), 7))]",
            "dailyInstantRestoreDays": "[min(max(parameters('instantRestoreRetentionDays'), 1), 5)]",
            "monthlyScheduleObj": "[if(parameters('enableMonthlyRetention'), createObject('monthlySchedule', createObject('retentionScheduleFormatType', 'Weekly', 'retentionScheduleWeekly', createObject('daysOfTheWeek', parameters('monthlyDaysOfWeek'), 'weeksOfTheMonth', parameters('monthlyWeeksOfMonth')), 'retentionTimes', variables('isoRunTimes'), 'retentionDuration', createObject('count', parameters('monthlyRetentionMonths'), 'durationType', 'Months'))), createObject())]",
            "yearlyScheduleObj": "[if(parameters('enableYearlyRetention'), createObject('yearlySchedule', createObject('retentionScheduleFormatType', 'Weekly', 'monthsOfYear', parameters('yearlyMonthsOfYear'), 'retentionScheduleWeekly', createObject('daysOfTheWeek', parameters('yearlyDaysOfWeek'), 'weeksOfTheMonth', parameters('yearlyWeeksOfMonth')), 'retentionTimes', variables('isoRunTimes'), 'retentionDuration', createObject('count', parameters('yearlyRetentionYears'), 'durationType', 'Years'))), createObject())]",
            "retentionPolicyWeekly": "[union(createObject('retentionPolicyType', 'LongTermRetentionPolicy', 'weeklySchedule', createObject('daysOfTheWeek', parameters('weeklyBackupDaysOfWeek'), 'retentionTimes', variables('isoRunTimes'), 'retentionDuration', createObject('count', variables('weeklyRetentionWeeks'), 'durationType', 'Weeks'))), variables('monthlyScheduleObj'), variables('yearlyScheduleObj'))]",
            "dailyPolicyId": "[if(or(equals(parameters('backupFrequency'), 'Daily'), equals(parameters('backupFrequency'), 'Both')), resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('vaultName'), format('{0}-daily', parameters('backupPolicyName'))), '')]",
            "weeklyPolicyId": "[if(or(equals(parameters('backupFrequency'), 'Weekly'), equals(parameters('backupFrequency'), 'Both')), resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('vaultName'), format('{0}-weekly', parameters('backupPolicyName'))), '')]",
            "dailyPolicyName": "[if(or(equals(parameters('backupFrequency'), 'Daily'), equals(parameters('backupFrequency'), 'Both')), format('{0}-daily', parameters('backupPolicyName')), '')]",
            "weeklyPolicyName": "[if(or(equals(parameters('backupFrequency'), 'Weekly'), equals(parameters('backupFrequency'), 'Both')), format('{0}-weekly', parameters('backupPolicyName')), '')]"
          },
          "resources": [
            {
              "condition": "[or(equals(parameters('backupFrequency'), 'Daily'), equals(parameters('backupFrequency'), 'Both'))]",
              "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', parameters('vaultName'), format('{0}-daily', parameters('backupPolicyName')))]",
              "properties": {
                "backupManagementType": "AzureIaasVM",
                "policyType": "V1",
                "schedulePolicy": {
                  "schedulePolicyType": "SimpleSchedulePolicy",
                  "scheduleRunFrequency": "Daily",
                  "scheduleRunTimes": "[variables('isoRunTimes')]"
                },
                "retentionPolicy": {
                  "retentionPolicyType": "LongTermRetentionPolicy",
                  "dailySchedule": {
                    "retentionTimes": "[variables('isoRunTimes')]",
                    "retentionDuration": {
                      "count": "[parameters('dailyRetentionDays')]",
                      "durationType": "Days"
                    }
                  }
                },
                "instantRpRetentionRangeInDays": "[variables('dailyInstantRestoreDays')]",
                "timeZone": "[parameters('backupTimeZone')]"
              }
            },
            {
              "condition": "[or(equals(parameters('backupFrequency'), 'Weekly'), equals(parameters('backupFrequency'), 'Both'))]",
              "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', parameters('vaultName'), format('{0}-weekly', parameters('backupPolicyName')))]",
              "properties": {
                "backupManagementType": "AzureIaasVM",
                "policyType": "V1",
                "schedulePolicy": {
                  "schedulePolicyType": "SimpleSchedulePolicy",
                  "scheduleRunFrequency": "Weekly",
                  "scheduleRunDays": "[parameters('weeklyBackupDaysOfWeek')]",
                  "scheduleRunTimes": "[variables('isoRunTimes')]"
                },
                "retentionPolicy": "[variables('retentionPolicyWeekly')]",
                "instantRpRetentionRangeInDays": 5,
                "timeZone": "[parameters('backupTimeZone')]"
              }
            }
          ],
          "outputs": {
            "backupPolicyIds": {
              "type": "array",
              "value": "[concat(if(not(equals(variables('dailyPolicyId'), '')), createArray(variables('dailyPolicyId')), createArray()), if(not(equals(variables('weeklyPolicyId'), '')), createArray(variables('weeklyPolicyId')), createArray()))]"
            },
            "backupPolicyNames": {
              "type": "array",
              "value": "[concat(if(not(equals(variables('dailyPolicyName'), '')), createArray(variables('dailyPolicyName')), createArray()), if(not(equals(variables('weeklyPolicyName'), '')), createArray(variables('weeklyPolicyName')), createArray()))]"
            },
            "monthlyRetentionEnabled": {
              "type": "bool",
              "value": "[parameters('enableMonthlyRetention')]"
            },
            "yearlyRetentionEnabled": {
              "type": "bool",
              "value": "[parameters('enableYearlyRetention')]"
            },
            "_unusedParams": {
              "type": "object",
              "value": {
                "instantRestoreRetentionDays": "[parameters('instantRestoreRetentionDays')]",
                "monthlyRetentionMonths": "[parameters('monthlyRetentionMonths')]",
                "monthlyRetentionScheduleFormat": "[parameters('monthlyRetentionScheduleFormat')]",
                "monthlyWeeksOfMonth": "[parameters('monthlyWeeksOfMonth')]",
                "monthlyDaysOfWeek": "[parameters('monthlyDaysOfWeek')]",
                "yearlyRetentionYears": "[parameters('yearlyRetentionYears')]",
                "yearlyRetentionScheduleFormat": "[parameters('yearlyRetentionScheduleFormat')]",
                "yearlyMonthsOfYear": "[parameters('yearlyMonthsOfYear')]",
                "yearlyWeeksOfMonth": "[parameters('yearlyWeeksOfMonth')]",
                "yearlyDaysOfWeek": "[parameters('yearlyDaysOfWeek')]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames')[copyIndex()]), 'Microsoft.Resources/deployments', format('recoveryVaultModule-{0}', variables('regions')[copyIndex()]))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "userAssignedIdentityModule-single",
      "resourceGroup": "[variables('rgNames')[0]]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "identityName": {
            "value": "[variables('uaiNames')[0]]"
          },
          "location": {
            "value": "[variables('regions')[0]]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1655801873398271449"
            }
          },
          "parameters": {
            "identityName": {
              "type": "string",
              "metadata": {
                "description": "Name of the user assigned identity to create"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the identity"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2018-11-30",
              "name": "[parameters('identityName')]",
              "location": "[parameters('location')]"
            }
          ],
          "outputs": {
            "identityResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName')), '2018-11-30').principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames')[copyIndex()]), 'Microsoft.Resources/deployments', format('recoveryVaultModule-{0}', variables('regions')[0]))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "roleAssignmentSubModule-single",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames')[0]), 'Microsoft.Resources/deployments', 'userAssignedIdentityModule-single'), '2025-04-01').outputs.principalId.value]"
          },
          "principalType": {
            "value": "ServicePrincipal"
          },
          "roleDefinitionId": {
            "value": "[parameters('remediationRoleDefinitionId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4773149094717698582"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal object id (GUID) to give the role to"
              }
            },
            "principalType": {
              "type": "string",
              "defaultValue": "ServicePrincipal",
              "metadata": {
                "description": "Principal type for the role assignment. Typical values: ServicePrincipal, User, Group"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Role definition id or resource id of the role definition. If only a GUID is provided it will be converted to a subscription-scoped roleDefinition resource id."
              }
            }
          },
          "variables": {
            "roleDefIdResolved": "[if(contains(parameters('roleDefinitionId'), '/'), parameters('roleDefinitionId'), subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId')))]",
            "roleAssignmentName": "[guid(subscription().id, parameters('principalId'), variables('roleDefIdResolved'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[variables('roleAssignmentName')]",
              "properties": {
                "roleDefinitionId": "[variables('roleDefIdResolved')]",
                "principalId": "[parameters('principalId')]",
                "principalType": "[parameters('principalType')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', variables('roleAssignmentName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames')[0]), 'Microsoft.Resources/deployments', 'userAssignedIdentityModule-single')]"
      ]
    }
  ],
  "outputs": {
    "vaultIds": {
      "type": "array",
      "copy": {
        "count": "[length(variables('regions'))]",
        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames')[copyIndex()]), 'Microsoft.Resources/deployments', format('recoveryVaultModule-{0}', variables('regions')[copyIndex()])), '2025-04-01').outputs.vaultId.value]"
      }
    },
    "backupPolicyIds": {
      "type": "array",
      "copy": {
        "count": "[length(variables('regions'))]",
        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames')[copyIndex()]), 'Microsoft.Resources/deployments', format('backupPolicyModule-{0}', variables('regions')[copyIndex()])), '2025-04-01').outputs.backupPolicyIds.value]"
      }
    },
    "backupPolicyNames": {
      "type": "array",
      "copy": {
        "count": "[length(variables('regions'))]",
        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames')[copyIndex()]), 'Microsoft.Resources/deployments', format('backupPolicyModule-{0}', variables('regions')[copyIndex()])), '2025-04-01').outputs.backupPolicyNames.value]"
      }
    },
    "userAssignedIdentityIds": {
      "type": "array",
      "copy": {
        "count": "[length(variables('regions'))]",
        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames')[0]), 'Microsoft.Resources/deployments', 'userAssignedIdentityModule-single'), '2025-04-01').outputs.identityResourceId.value]"
      }
    },
    "userAssignedIdentityPrincipalIds": {
      "type": "array",
      "copy": {
        "count": "[length(variables('regions'))]",
        "input": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgNames')[0]), 'Microsoft.Resources/deployments', 'userAssignedIdentityModule-single'), '2025-04-01').outputs.principalId.value]"
      }
    }
  }
}