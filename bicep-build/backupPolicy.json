{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "16574618552209008552"
    }
  },
  "parameters": {
    "vaultName": {
      "type": "string",
      "metadata": {
        "description": "Parent Recovery Services Vault resource name"
      }
    },
    "backupPolicyName": {
      "type": "string",
      "metadata": {
        "description": "Name of the backup policy"
      }
    },
    "backupFrequency": {
      "type": "string",
      "defaultValue": "Daily",
      "allowedValues": [
        "Daily",
        "Weekly",
        "Both"
      ],
      "metadata": {
        "description": "Backup frequency: Daily, Weekly, or Both"
      }
    },
    "backupScheduleRunTimes": {
      "type": "array",
      "metadata": {
        "description": "Backup run times (UTC). Example: [ \"02:30\", \"14:00\" ] or full ISO times depending on API expectations."
      }
    },
    "weeklyBackupDaysOfWeek": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Weekly run days (used when backupFrequency == \"Weekly\"). Example: [ \"Sunday\", \"Wednesday\" ]"
      }
    },
    "dailyRetentionDays": {
      "type": "int",
      "defaultValue": 14,
      "metadata": {
        "description": "Retention in days for daily backups"
      }
    },
    "weeklyRetentionDays": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "Retention in days for weekly backups"
      }
    },
    "instantRestoreRetentionDays": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Instant Restore snapshot retention in days"
      }
    },
    "enableMonthlyRetention": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable additional monthly retention tier (for weekly policy)"
      }
    },
    "monthlyRetentionMonths": {
      "type": "int",
      "defaultValue": 60,
      "metadata": {
        "description": "Monthly retention duration in months"
      }
    },
    "monthlyRetentionScheduleFormat": {
      "type": "string",
      "defaultValue": "Weekly",
      "allowedValues": [
        "Weekly"
      ],
      "metadata": {
        "description": "Monthly retention schedule format type"
      }
    },
    "monthlyWeeksOfMonth": {
      "type": "array",
      "defaultValue": [
        "First"
      ],
      "allowedValues": [
        "First",
        "Second",
        "Third",
        "Fourth",
        "Last"
      ],
      "metadata": {
        "description": "Monthly retention weeks of the month"
      }
    },
    "monthlyDaysOfWeek": {
      "type": "array",
      "defaultValue": [
        "Sunday"
      ],
      "allowedValues": [
        "Sunday",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday"
      ],
      "metadata": {
        "description": "Monthly retention days of the week"
      }
    },
    "enableYearlyRetention": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable additional yearly retention tier (for weekly policy)"
      }
    },
    "yearlyRetentionYears": {
      "type": "int",
      "defaultValue": 10,
      "metadata": {
        "description": "Yearly retention duration in years"
      }
    },
    "yearlyRetentionScheduleFormat": {
      "type": "string",
      "defaultValue": "Weekly",
      "allowedValues": [
        "Weekly"
      ],
      "metadata": {
        "description": "Yearly retention schedule format type"
      }
    },
    "yearlyMonthsOfYear": {
      "type": "array",
      "defaultValue": [
        "January",
        "February",
        "March"
      ],
      "allowedValues": [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December"
      ],
      "metadata": {
        "description": "Yearly retention months of year"
      }
    },
    "yearlyWeeksOfMonth": {
      "type": "array",
      "defaultValue": [
        "First"
      ],
      "allowedValues": [
        "First",
        "Second",
        "Third",
        "Fourth",
        "Last"
      ],
      "metadata": {
        "description": "Yearly retention weeks of the month"
      }
    },
    "yearlyDaysOfWeek": {
      "type": "array",
      "defaultValue": [
        "Sunday"
      ],
      "allowedValues": [
        "Sunday",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday"
      ],
      "metadata": {
        "description": "Yearly retention days of the week"
      }
    },
    "backupTimeZone": {
      "type": "string",
      "defaultValue": "UTC",
      "metadata": {
        "description": "Time zone for backup scheduling (e.g., \"UTC\")"
      }
    }
  },
  "variables": {
    "weeklyRetentionWeeks": "[int(div(add(parameters('weeklyRetentionDays'), 6), 7))]",
    "dailyPolicyId": "[if(or(equals(parameters('backupFrequency'), 'Daily'), equals(parameters('backupFrequency'), 'Both')), resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('vaultName'), if(equals(parameters('backupFrequency'), 'Both'), format('{0}-daily', parameters('backupPolicyName')), parameters('backupPolicyName'))), '')]",
    "weeklyPolicyId": "[if(or(equals(parameters('backupFrequency'), 'Weekly'), equals(parameters('backupFrequency'), 'Both')), resourceId('Microsoft.RecoveryServices/vaults/backupPolicies', parameters('vaultName'), if(equals(parameters('backupFrequency'), 'Both'), format('{0}-weekly', parameters('backupPolicyName')), parameters('backupPolicyName'))), '')]",
    "dailyPolicyName": "[if(or(equals(parameters('backupFrequency'), 'Daily'), equals(parameters('backupFrequency'), 'Both')), if(equals(parameters('backupFrequency'), 'Both'), format('{0}-daily', parameters('backupPolicyName')), parameters('backupPolicyName')), '')]",
    "weeklyPolicyName": "[if(or(equals(parameters('backupFrequency'), 'Weekly'), equals(parameters('backupFrequency'), 'Both')), if(equals(parameters('backupFrequency'), 'Both'), format('{0}-weekly', parameters('backupPolicyName')), parameters('backupPolicyName')), '')]"
  },
  "resources": [
    {
      "condition": "[or(equals(parameters('backupFrequency'), 'Daily'), equals(parameters('backupFrequency'), 'Both'))]",
      "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
      "apiVersion": "2019-05-13",
      "name": "[format('{0}/{1}', parameters('vaultName'), if(equals(parameters('backupFrequency'), 'Both'), format('{0}-daily', parameters('backupPolicyName')), parameters('backupPolicyName')))]",
      "location": "[resourceGroup().location]",
      "properties": {
        "backupManagementType": "AzureIaasVM",
        "instantRpRetentionRangeInDays": "[parameters('instantRestoreRetentionDays')]",
        "schedulePolicy": {
          "schedulePolicyType": "SimpleSchedulePolicy",
          "scheduleRunFrequency": "Daily",
          "scheduleRunTimes": "[parameters('backupScheduleRunTimes')]"
        },
        "retentionPolicy": {
          "retentionPolicyType": "LongTermRetentionPolicy",
          "dailySchedule": {
            "retentionTimes": "[parameters('backupScheduleRunTimes')]",
            "retentionDuration": {
              "count": "[parameters('dailyRetentionDays')]",
              "durationType": "Days"
            }
          }
        },
        "timeZone": "[parameters('backupTimeZone')]"
      }
    },
    {
      "condition": "[or(equals(parameters('backupFrequency'), 'Weekly'), equals(parameters('backupFrequency'), 'Both'))]",
      "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
      "apiVersion": "2019-05-13",
      "name": "[format('{0}/{1}', parameters('vaultName'), if(equals(parameters('backupFrequency'), 'Both'), format('{0}-weekly', parameters('backupPolicyName')), parameters('backupPolicyName')))]",
      "location": "[resourceGroup().location]",
      "properties": {
        "backupManagementType": "AzureIaasVM",
        "instantRpRetentionRangeInDays": "[parameters('instantRestoreRetentionDays')]",
        "schedulePolicy": {
          "schedulePolicyType": "SimpleSchedulePolicy",
          "scheduleRunFrequency": "Weekly",
          "scheduleRunDays": "[parameters('weeklyBackupDaysOfWeek')]",
          "scheduleRunTimes": "[parameters('backupScheduleRunTimes')]"
        },
        "retentionPolicy": {
          "retentionPolicyType": "LongTermRetentionPolicy",
          "weeklySchedule": {
            "daysOfTheWeek": "[parameters('weeklyBackupDaysOfWeek')]",
            "retentionTimes": "[parameters('backupScheduleRunTimes')]",
            "retentionDuration": {
              "count": "[variables('weeklyRetentionWeeks')]",
              "durationType": "Weeks"
            }
          },
          "monthlySchedule": {
            "retentionScheduleFormatType": "[parameters('monthlyRetentionScheduleFormat')]",
            "retentionScheduleWeekly": {
              "daysOfTheWeek": "[parameters('monthlyDaysOfWeek')]",
              "weeksOfTheMonth": "[parameters('monthlyWeeksOfMonth')]"
            },
            "retentionTimes": "[parameters('backupScheduleRunTimes')]",
            "retentionDuration": {
              "count": "[parameters('monthlyRetentionMonths')]",
              "durationType": "Months"
            }
          },
          "yearlySchedule": {
            "retentionScheduleFormatType": "[parameters('yearlyRetentionScheduleFormat')]",
            "monthsOfYear": "[parameters('yearlyMonthsOfYear')]",
            "retentionScheduleDaily": {
              "daysOfTheMonth": [
                {
                  "date": 1,
                  "isLast": false
                }
              ]
            },
            "retentionScheduleWeekly": {
              "daysOfTheWeek": "[parameters('yearlyDaysOfWeek')]",
              "weeksOfTheMonth": "[parameters('yearlyWeeksOfMonth')]"
            },
            "retentionTimes": "[parameters('backupScheduleRunTimes')]",
            "retentionDuration": {
              "count": "[parameters('yearlyRetentionYears')]",
              "durationType": "Years"
            }
          }
        },
        "timeZone": "[parameters('backupTimeZone')]"
      }
    }
  ],
  "outputs": {
    "backupPolicyIds": {
      "type": "array",
      "value": "[concat(if(not(equals(variables('dailyPolicyId'), '')), createArray(variables('dailyPolicyId')), createArray()), if(not(equals(variables('weeklyPolicyId'), '')), createArray(variables('weeklyPolicyId')), createArray()))]"
    },
    "backupPolicyNames": {
      "type": "array",
      "value": "[concat(if(not(equals(variables('dailyPolicyName'), '')), createArray(variables('dailyPolicyName')), createArray()), if(not(equals(variables('weeklyPolicyName'), '')), createArray(variables('weeklyPolicyName')), createArray()))]"
    },
    "monthlyRetentionEnabled": {
      "type": "bool",
      "value": "[parameters('enableMonthlyRetention')]"
    },
    "yearlyRetentionEnabled": {
      "type": "bool",
      "value": "[parameters('enableYearlyRetention')]"
    }
  }
}