parameters:
- name: managementGroupId
  type: string
  default: ''
- name: vmTagName
  type: string
  default: 'backup'
- name: vmTagValue
  type: string
  default: 'true'
- name: vaultName
  type: string
  default: ''
- name: vaultResourceGroup
  type: string
  default: ''
pool:
  vmImage: 'windows-latest'

stages:
- stage: AuditOnly
  displayName: 'Deploy Audit Policy only'
  jobs:
  - job: DeployAuditPolicy
    displayName: 'Deploy Audit Policy (audit VMs without backup)'
    steps:
    - task: AzurePowerShell@5
      inputs:
        azureSubscription: 'bicep_deploy_SC'
        ScriptType: 'FilePath'
        ScriptPath: '$(System.DefaultWorkingDirectory)/scripts/Deploy-AuditPolicy.ps1'
        ScriptArguments: >
          -ManagementGroupId "${{ parameters.managementGroupId }}" \
          -PolicyName "${{ parameters.vaultName }}-audit-vm-backup-policy" \
          -PolicyAssignmentName "${{ parameters.vaultName }}-audit-vm-backup-assignment" \
          -VmTagName "${{ parameters.vmTagName }}" \
          -VmTagValue "${{ parameters.vmTagValue }}"
        azurePowerShellVersion: 'LatestVersion'
