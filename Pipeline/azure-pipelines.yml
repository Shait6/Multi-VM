parameters:
  - name: serviceConnection
    type: string
    default: 'bicep_deploy_SC'
    displayName: 'Azure Service Connection'
  - name: subscriptionId
    type: string
    default: ''
    displayName: 'Target Subscription Id (blank -> service connection default)'
  - name: deploymentLocation
    type: string
    values:
      - westeurope
      - northeurope
      - swedencentral
      - germanywestcentral
    default: westeurope
    displayName: 'Subscription Deployment Location'
  - name: backupFrequency
    type: string
    values:
      - Daily
      - Weekly
      - Both
    default: Daily
    displayName: 'Backup Frequency'
  - name: retentionProfile
    type: string
    default: '14|30|0|backup|true'
    displayName: 'Retention Profile Daily|Weekly|Yearly|TagName|TagValue (Yearly=0 disables yearly tier)'
  - name: weeklyBackupDaysOfWeekString
    type: string
    default: 'Sunday,Wednesday'
    displayName: 'Weekly Backup Days (comma separated)'
  - name: backupScheduleTimeString
    type: string
    default: '23:00'
    displayName: 'Daily schedule time (HH:mm)'
  - name: backupTimeZone
    type: string
    values:
      - 'UTC'
      - 'Central Europe Standard Time'
    default: 'UTC'
    displayName: 'Backup Time Zone (Windows Time Zone ID)'
  - name: instantRestoreRetentionDays
    type: number
    default: 5
    displayName: 'Instant Restore Retention Days (1..5)'
  - name: enableMonthlyRetention
    type: string
    values: ['true','false']
    default: 'false'
    displayName: 'Enable Monthly Tier'
  - name: monthlyRetentionMonths
    type: number
    default: 0
    displayName: 'Monthly Retention (months)'
  - name: monthlyWeeksOfMonth
    type: string
    default: 'First'
    displayName: 'Monthly Weeks Of Month'
  - name: monthlyDaysOfWeek
    type: string
    default: 'Sunday'
    displayName: 'Monthly Days Of Week'
  - name: yearlyMonthsOfYear
    type: string
    default: 'January'
    displayName: 'Yearly Months Of Year'
  - name: yearlyWeeksOfMonth
    type: string
    default: 'First'
    displayName: 'Yearly Weeks Of Month'
  - name: yearlyDaysOfWeek
    type: string
    default: 'Sunday'
    displayName: 'Yearly Days Of Week'
  - name: enableAutoRemediation
    type: string
    values: ['true','false']
    default: 'false'
    displayName: 'Enable Auto-Remediation (DeployIfNotExists)'
  - name: remediationRegions
    type: string
    default: ''
    displayName: 'Comma-separated regions to remediate (empty -> deploymentLocation)'
  - name: waitMinutesBeforeRemediation
    type: number
    default: 5
    displayName: 'Minutes to wait before remediation'

stages:
  - stage: BuildAndDeploy
    displayName: 'Build & Deploy Backup Infrastructure'
    jobs:
      - job: BuildDeploy
        displayName: 'Build Bicep and Deploy'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: 'Bicep Build (syntax)'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                try { az bicep version | Out-Null } catch { az bicep install }
                az bicep build --file main.bicep --outdir bicep-build
          - task: AzureCLI@2
            displayName: 'Subscription Deployment'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                if (-not [string]::IsNullOrWhiteSpace('${{ parameters.subscriptionId }}')) { $env:SUBSCRIPTION_ID='${{ parameters.subscriptionId }}' }
                $env:DEPLOYMENT_LOCATION = '${{ parameters.deploymentLocation }}'
                $env:BACKUP_FREQUENCY    = '${{ parameters.backupFrequency }}'
                $env:WEEKLY_DAYS         = '${{ parameters.weeklyBackupDaysOfWeekString }}'
                $env:RETENTION_PROFILE   = '${{ parameters.retentionProfile }}'
                $env:BACKUP_TIME         = '${{ parameters.backupScheduleTimeString }}'
                $env:BACKUP_TZ           = '${{ parameters.backupTimeZone }}'
                $env:INSTANT_RESTORE_DAYS= '${{ parameters.instantRestoreRetentionDays }}'
                . ./scripts/Deploy-BackupInfra.ps1
  - stage: DeployPolicyDefinition
    displayName: 'Deploy Policy Definition'
    dependsOn: BuildAndDeploy
    jobs:
      - job: DeployPolicy
        displayName: 'Create/Update Custom Policy Definition'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: 'Deploy policy definition (verbatim)'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $subId = '${{ parameters.subscriptionId }}'
                if (-not [string]::IsNullOrWhiteSpace($subId)) { az account set --subscription $subId }
                $policyName = 'Custom-CentralVmBackup-AnyOS'
                $policyFile = 'policy-definitions/customCentralVmBackup.full.json'
                if (-not (Test-Path $policyFile)) { Write-Host "Policy file not found: $policyFile"; exit 0 }
                Write-Host "Creating policy definition $policyName from $policyFile (PUT via az rest)"
                $curSub = az account show --query id -o tsv
                $uri = "/subscriptions/$curSub/providers/Microsoft.Authorization/policyDefinitions/$policyName?api-version=2021-06-01"
                az rest --method put --uri $uri --body "@$policyFile" -o json
                Write-Host "Policy definition deployed (showing stored policyRule snippet)"
                az policy definition show -n $policyName --query properties.policyRule -o json | ConvertFrom-Json | ConvertTo-Json -Depth 6
  - stage: Remediate
    displayName: 'Auto-enable Backup Remediation'
    dependsOn: DeployPolicyDefinition
    condition: and(succeeded(), eq('${{ parameters.enableAutoRemediation }}','true'))
    jobs:
      - job: RemediateTaggedVMs
        displayName: 'Run Remediation Script'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: 'Trigger Remediation (no polling)'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $subId = '${{ parameters.subscriptionId }}'
                if (-not [string]::IsNullOrWhiteSpace($subId)) { az account set --subscription $subId }
                $env:REMEDIATION_REGIONS = '${{ parameters.remediationRegions }}'
                $env:DEPLOYMENT_LOCATION = '${{ parameters.deploymentLocation }}'
                $env:BACKUP_FREQUENCY    = '${{ parameters.backupFrequency }}'
                # Parse tags from composite retention profile
                $parts = "${{ parameters.retentionProfile }}".Split('|')
                if ($parts.Count -ge 5) { $env:VM_TAG_NAME = $parts[3]; $env:VM_TAG_VALUE = $parts[4] }
                . ./scripts/Start-BackupRemediation.ps1
          # No long polling or artifacts; remediation visible in Policy > Remediations

