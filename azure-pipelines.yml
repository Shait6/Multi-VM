parameters:
  - name: serviceConnection
    type: string
    default: 'bicep_deploy_SC'
    displayName: 'Azure Service Connection'
  - name: subscriptionId
    type: string
    default: ''
    displayName: 'Target Subscription Id (blank -> service connection default)'
  - name: deploymentLocation
    type: string
    values:
      - westeurope
      - northeurope
      - swedencentral
      - germanywestcentral
    default: westeurope
    displayName: 'Subscription Deployment Location'
  - name: backupFrequency
    type: string
    values:
      - Daily
      - Weekly
      - Both
    default: Daily
    displayName: 'Backup Frequency'
  - name: retentionProfile
    type: string
    default: '14|30|0|backup|true'
    displayName: 'Retention Profile Daily|Weekly|Yearly|TagName|TagValue (Yearly=0 disables yearly tier)'
  - name: weeklyBackupDaysOfWeekString
    type: string
    default: 'Sunday,Wednesday'
    displayName: 'Weekly Backup Days (comma separated)'
  - name: backupScheduleTimeString
    type: string
    default: '23:00'
    displayName: 'Daily schedule time (HH:mm)'
  - name: backupTimeZone
    type: string
    default: 'UTC'
    displayName: 'Backup Time Zone'
  - name: instantRestoreRetentionDays
    type: number
    default: 5
    displayName: 'Instant Restore Retention Days (1..5)'
  - name: enableMonthlyRetention
    type: string
    values: ['true','false']
    default: 'false'
    displayName: 'Enable Monthly Tier'
  - name: monthlyRetentionMonths
    type: number
    default: 0
    displayName: 'Monthly Retention (months)'
  - name: monthlyWeeksOfMonth
    type: string
    default: 'First'
    displayName: 'Monthly Weeks Of Month'
  - name: monthlyDaysOfWeek
    type: string
    default: 'Sunday'
    displayName: 'Monthly Days Of Week'
  - name: yearlyMonthsOfYear
    type: string
    default: 'January'
    displayName: 'Yearly Months Of Year'
  - name: yearlyWeeksOfMonth
    type: string
    default: 'First'
    displayName: 'Yearly Weeks Of Month'
  - name: yearlyDaysOfWeek
    type: string
    default: 'Sunday'
    displayName: 'Yearly Days Of Week'
  - name: enableAutoRemediation
    type: string
    values: ['true','false']
    default: 'false'
    displayName: 'Enable Auto-Remediation (DeployIfNotExists)'
  - name: remediationRegions
    type: string
    default: ''
    displayName: 'Comma-separated regions to remediate (empty -> deploymentLocation)'
  - name: waitMinutesBeforeRemediation
    type: number
    default: 5
    displayName: 'Minutes to wait before remediation'

stages:
  - stage: BuildAndDeploy
    displayName: 'Build & Deploy Backup Infrastructure'
    jobs:
      - job: BuildDeploy
        displayName: 'Build Bicep and Deploy'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: 'Bicep Build (syntax)'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                try { az bicep version | Out-Null } catch { az bicep install }
                az bicep build --file main.bicep --outdir bicep-build
          - task: AzureCLI@2
            displayName: 'Subscription Deployment'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $subId = '${{ parameters.subscriptionId }}'
                if (-not [string]::IsNullOrWhiteSpace($subId)) { az account set --subscription $subId }
                $deployName = "multi-region-backup-$(Get-Date -Format yyyyMMddHHmmss)"
                $weeklyDays = "${{ parameters.weeklyBackupDaysOfWeekString }}".Split(',') | ForEach-Object { $_.Trim() }
                $runTimes   = @("${{ parameters.backupScheduleTimeString }}")
                $profileRaw = "${{ parameters.retentionProfile }}"
                $parts = $profileRaw.Split('|')
                if ($parts.Count -lt 5) { throw "Invalid retentionProfile format '$profileRaw'. Expected Daily|Weekly|Yearly|TagName|TagValue." }
                $dailyRetention = [int]$parts[0]
                $weeklyWeeks    = [int]$parts[1]
                $yearlyYears    = [int]$parts[2]
                $tagName        = $parts[3]
                $tagValue       = $parts[4]
                if ($dailyRetention -lt 7) { throw "dailyRetentionDays ($dailyRetention) must be >=7" }
                if ($weeklyWeeks -lt 1) { throw "weeklyWeeks ($weeklyWeeks) must be >=1" }
                $weeklyRetention = $weeklyWeeks * 7
                $enableYearly = $yearlyYears -gt 0
                $instantInput = [int]${{ parameters.instantRestoreRetentionDays }}
                $instantClamped = [Math]::Min([Math]::Max($instantInput,1),5)
                if ("${{ parameters.backupFrequency }}" -eq 'Weekly') { $instantEffective = 5 } else { $instantEffective = $instantClamped }
                $roleGuid = 'b24988ac-6180-42a0-ab88-20f7382dd24c'
                $paramContent = @{
                  backupFrequency        = @{ value = "${{ parameters.backupFrequency }}" }
                  dailyRetentionDays     = @{ value = $dailyRetention }
                  weeklyRetentionDays    = @{ value = $weeklyRetention }
                  weeklyBackupDaysOfWeek = @{ value = $weeklyDays }
                  backupScheduleRunTimes = @{ value = $runTimes }
                  backupTimeZone         = @{ value = "${{ parameters.backupTimeZone }}" }
                  instantRestoreRetentionDays = @{ value = $instantEffective }
                  enableMonthlyRetention = @{ value = ('${{ parameters.enableMonthlyRetention }}' -eq 'true') }
                  monthlyRetentionMonths = @{ value = ${{ parameters.monthlyRetentionMonths }} }
                  monthlyWeeksOfMonth    = @{ value = ("${{ parameters.monthlyWeeksOfMonth }}".Split(',') | ForEach-Object { $_.Trim() }) }
                  monthlyDaysOfWeek      = @{ value = ("${{ parameters.monthlyDaysOfWeek }}".Split(',') | ForEach-Object { $_.Trim() }) }
                  enableYearlyRetention  = @{ value = $enableYearly }
                  yearlyRetentionYears   = @{ value = $yearlyYears }
                  yearlyMonthsOfYear     = @{ value = ("${{ parameters.yearlyMonthsOfYear }}".Split(',') | ForEach-Object { $_.Trim() }) }
                  yearlyWeeksOfMonth     = @{ value = ("${{ parameters.yearlyWeeksOfMonth }}".Split(',') | ForEach-Object { $_.Trim() }) }
                  yearlyDaysOfWeek       = @{ value = ("${{ parameters.yearlyDaysOfWeek }}".Split(',') | ForEach-Object { $_.Trim() }) }
                  remediationRoleDefinitionId = @{ value = $roleGuid }
                }
                $paramContent | ConvertTo-Json -Depth 4 | Out-File bicep-params.json -Encoding utf8
                Write-Host "Starting deployment $deployName backupFrequency=${{ parameters.backupFrequency }}"
                $failed = $false
                try { az deployment sub create --name $deployName --location "${{ parameters.deploymentLocation }}" --template-file main.bicep --parameters @bicep-params.json -o json > deployment-result.json } catch { $failed = $true }
                if ($failed) {
                  az deployment sub show --name $deployName -o json > deployment-show.json 2>$null
                  az deployment operation sub list --name $deployName -o json > deployment-operations.json 2>$null
                  Write-Host "Deployment failed; diagnostics captured."; exit 1
                }
                $outputs = az deployment sub show --name $deployName --query properties.outputs -o json | ConvertFrom-Json
                $outputs | ConvertTo-Json -Depth 10 | Out-File deployment-outputs.json -Encoding utf8
                Write-Host "Outputs saved -> deployment-outputs.json"
  - stage: Remediate
    displayName: 'Auto-enable Backup Remediation'
    dependsOn: BuildAndDeploy
    condition: and(succeeded(), eq('${{ parameters.enableAutoRemediation }}','true'))
    jobs:
      - job: RemediateTaggedVMs
        displayName: 'Run Remediation Script'
        pool:
          vmImage: 'windows-latest'
        steps:
          - checkout: self
          - task: AzureCLI@2
            displayName: 'Invoke Remediation Script'
            inputs:
              azureSubscription: '${{ parameters.serviceConnection }}'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $subId = '${{ parameters.subscriptionId }}'
                if (-not [string]::IsNullOrWhiteSpace($subId)) { az account set --subscription $subId }
                Write-Host "Running remediation script regions='${{ parameters.remediationRegions }}'"
                . ./scripts/Invoke-BackupRemediation.ps1 -FailOnError
                Write-Host "Remediation summary:"; Get-Content backup-remediation-summary.json | Write-Host
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Remediation Summary'
            inputs:
              PathtoPublish: 'backup-remediation-summary.json'
              ArtifactName: 'remediation-summary'
              publishLocation: 'Container'

